(function(e){"use strict";function r(t){var n=e(t);while(n.length>0){var r=n.data("nested-fields.options");if(r)return r;n=n.parent()}return null}function i(e){e.add.bind("click.nested-fields",function(t){t.preventDefault(),u(null,e)})}function s(t,n){e(t.itemSelector,n).each(function(e,n){c(n,t)})}function o(t){var n=new RegExp(t.newItemIndex,"g"),r=(new Date).getTime(),i=t.itemTemplate.html();t.unescapeTemplate&&(i=d(i));var s=e(i.replace(n,r));return s.attr("data-new-record",!0),s.attr("data-record-id",r),c(s,t),s}function u(e,t){function r(){e&&e(n),a(t),t.container.append(n)}var n=o(t);return t.skipBefore?r():(t.beforeInsert(n,r),t.beforeInsert.length<=1&&r()),t.skipAfter||t.afterInsert(n),n}function a(e){p(e).remove()}function f(t,n){function r(){i.attr("data-new-record")?i.remove():(i.find("INPUT[name$='[_destroy]']").val("true"),i.hide()),l(n)}var i=e(t);return n.skipBefore?r():(n.beforeRemove(i,r),n.beforeRemove.length<=1&&r()),n.skipAfter||n.afterRemove(i),i}function l(e){if(h(e).length===0){var t=e.emptyTemplate.html();t&&(e.unescapeTemplate&&(t=d(t)),e.container.append(t))}}function c(t,n){var r=e(t).find(n.removeSelector),i=r.attr("data-confirm"),s=i?"confirm:complete":"click";r.bind(s+".nested-fields",function(e,r){return e.preventDefault(),(r===undefined||r===!0)&&f(t,n),!1})}function h(e){return e.container.find(e.itemSelector+":visible")}function p(e){return e.container.find(e.emptySelector)}function d(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes.length===0?"":jQuery.trim(t.childNodes[0].nodeValue)}function v(e){console&&console.log&&console.log(e)}var t={beforeInsert:function(e,t){t()},afterInsert:function(e){},beforeRemove:function(e,t){t()},afterRemove:function(e){},itemTemplateSelector:".item.template",emptyTemplateSelector:".empty.template",containerSelector:".items, .container",itemSelector:".item",emptySelector:".empty",addSelector:".add",removeSelector:".remove",newItemIndex:"new_nested_item",unescapeTemplate:!0},n={init:function(n){return this.each(function(){var r=e(this);if(r.data("nested-fields.options"))return v("Nested fields already defined for this element. If you want to redefine options, destroy it and init again."),r;n=e.extend({},t,n),n.itemTemplate=e(n.itemTemplateSelector,r),n.emptyTemplate=e(n.emptyTemplateSelector,r),n.container=e(n.containerSelector,r),n.add=e(n.addSelector,r),r.data("nested-fields.options",n),i(n),s(n,r)})},insert:function(t,n){return n=e.extend({},r(this),n),u(t,n)},remove:function(t,n){return n=e.extend({},r(this),n),f(t,n)},removeAll:function(t){t=e.extend({},r(this),t),e(n.items.apply(this)).each(function(e,r){n.remove(r,t)})},items:function(){return h(r(this))},destroy:function(){e(this).removeData("nested-fields.options"),e("*",this).unbind(".nested-fields")}};e.fn.nestedFields=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.nestedFields")}})(jQuery);